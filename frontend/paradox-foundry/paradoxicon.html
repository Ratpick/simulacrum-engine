// === Mobius / Black-hole header animation ===
(function(){
  let rafId;
  function project(point, w, h){
    // very light perspective projection
    const fov = 280; // tweakable
    const scale = fov / (fov + point.z);
    return {
      x: w/2 + point.x * scale,
      y: h/2 + point.y * scale
    };
  }

  function mobius(u, v, radius){
    // Parametric Möbius strip
    // u ∈ [0, 2π), v ∈ [-1, 1]
    const half = v * 0.5;
    const x = (radius + half * Math.cos(u/2)) * Math.cos(u);
    const y = (radius + half * Math.cos(u/2)) * Math.sin(u);
    const z = half * Math.sin(u/2) * radius * 0.6;
    return {x, y, z};
  }

  function initBlackHoleHeader(){
    const canvas = document.getElementById('blackHoleHeaderCanvas');
    const header = document.getElementById('animation-header');
    if(!canvas || !header){ return; }

    const ctx = canvas.getContext('2d', { alpha: true });
    const DPR = Math.min(window.devicePixelRatio || 1, 2);

    function resize(){
      const {width, height} = header.getBoundingClientRect();
      canvas.width  = Math.max(1, Math.floor(width * DPR));
      canvas.height = Math.max(1, Math.floor(height * DPR));
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
    }
    resize();
    window.addEventListener('resize', () => {
      cancelAnimationFrame(rafId);
      resize();
      animate(); // restart
    }, { passive:true });

    // particle field along the strip
    const COUNT = 800;
    const radius = Math.min(canvas.width, canvas.height) * 0.22;
    const parts = new Array(COUNT).fill(0).map(() => ({
      u: Math.random() * Math.PI * 2,
      v: (Math.random() * 2 - 1) * 0.9,
      s: 0.004 + Math.random() * 0.006
    }));

    let t = 0;
    function animate(){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // background vignette
      const g = ctx.createRadialGradient(w/2, h/2, 10, w/2, h/2, Math.max(w,h)*0.6);
      g.addColorStop(0, 'rgba(0,0,0,0.0)');
      g.addColorStop(1, 'rgba(0,0,0,0.9)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      // twin gravity wells
      ctx.globalCompositeOperation = 'lighter';
      for(let i=0;i<parts.length;i++){
        const p = parts[i];
        p.u = (p.u + p.s) % (Math.PI*2);
        // gentle precession for "black hole" feel
        const m = mobius(p.u + t*0.0007, p.v, radius);
        const proj = project(m, w, h);

        // star
        ctx.beginPath();
        const alpha = 0.35 + 0.65 * (0.5 + 0.5 * Math.sin(p.u*3 + t*0.002));
        ctx.fillStyle = `rgba(212,175,55,${alpha})`;
        const size = 1 + 1.5 * alpha * (window.devicePixelRatio||1);
        ctx.arc(proj.x, proj.y, size, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.globalCompositeOperation = 'source-over';

      t += 1;
      rafId = requestAnimationFrame(animate);
    }
    animate();
  }

  // Expose/boot
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBlackHoleHeader, { once:true });
  } else {
    initBlackHoleHeader();
  }
  // also export to window for manual reinit if needed
  window.initBlackHoleHeader = initBlackHoleHeader;
})();
